<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
      integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
      crossorigin=""
    ></script>
    <title>Document</title>
    <style>
      #map {
        height: 95vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      const sheetId = "1NXpuP8-apUgQgL3PBOlPC2FPNvc-Wq19Ei7u9eUCmFs";
      const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?`;
      const sheetName = "Sheet1";
      const query = encodeURIComponent("Select *");
      const url = `${base}&sheet=${sheetName}&tq=${query}`;
      const data = [];
      document.addEventListener("DOMContentLoaded", init);
      const output = document.querySelector(".output");
      function init() {
        fetch(url)
          .then((res) => res.text())
          .then((rep) => {
            //Remove additional text and extract only JSON:
            const jsonData = JSON.parse(rep.substring(47).slice(0, -2));

            const colz = [];
            jsonData.table.cols.forEach((heading) => {
              if (heading.label) {
                let column = heading.label;
                colz.push(column);
              }
            });
            jsonData.table.rows.forEach((rowData) => {
              const row = {};
              colz.forEach((ele, ind) => {
                row[ele] = rowData.c[ind] != null ? rowData.c[ind].v : "";
              });
              data.push(row);
            });

            console.log(data);
            const markers = Object.values(
              data.reduce((accumulator, item) => {
                const { ID, ...rest } = item;
                return {
                  ...accumulator,
                  [ID]: { ID, ...rest },
                };
              }, {})
            );
            console.log(markers);


            
            var map = L.map("map").setView([37.43580724, 24.92247321], 13);
            map.attributionControl.setPrefix("");

            L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
              maxZoom: 19,
              attribution:
                '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            }).addTo(map);

            for (var i = 0; i < markers.length; i++) {
              var lon = markers[i].x;
              var lat = markers[i].y;
              var popupText = markers[i].Ultrasonic.toString() + " cm available"

              console.log(markers[i].Ultrasonic)
              function options (dist){
                if(dist <= 20){
                return {
                  color : '#AA4A44',
                  radius: 6
                } 
                }else{
                  return {
                    radius: 6,
                    opacity: 50
                  }
              }
              }
              var markerLocation = new L.LatLng(lat, lon);
              var marker = new L.circleMarker(markerLocation, options(markers[i].Ultrasonic));
              map.addLayer(marker);

              marker.bindPopup(popupText);
            }
          });
      }
    </script>
  </body>
</html>
